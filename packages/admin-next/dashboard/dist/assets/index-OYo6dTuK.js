import{u as W,j as e,T as N,a6 as G,ao as H,a7 as M,ap as te,aJ as Z,an as le}from"./index-S--WvUSo.js";import{u as de,a as R}from"./route-focus-modal-MMx5Xnk0.js";import{t as ue}from"./zod-jt04JUtm.js";import{c as me,F as a,a as F,u as pe}from"./form-0PHaH8g8.js";import{r as C}from"./react-PzSkSLoa.js";import{f as xe}from"./price-lists---tSXD3D.js";import{c as fe}from"./cast-number-oeIUIgsb.js";import{a as he}from"./money-amount-helpers--myf8Rla.js";import{D as V}from"./divider-GiVPCNCn.js";import{S as L}from"./split-view-l-bJVVse.js";import{a as re,D as ie}from"./use-data-table-TeZp00wg.js";import{u as ge}from"./customer-groups-G4KCvF3b.js";import{u as je,a as be}from"./use-customer-group-table-columns-uQ7G548z.js";import{X as ye}from"./x-mark-mini-aYDSd38M.js";import{H as ve}from"./heading-cSlef4Su.js";import{R as B}from"./radio-group-asQL-yXP.js";import{I as Se}from"./input-A29ux7yj.js";import{T as Ce}from"./textarea-D4fuXHvE.js";import{S as X}from"./switch-VR1xZXYU.js";import{D as J}from"./date-picker-s8-9mila.js";import{B as z}from"./button-Pc5Xo8ua.js";import{C as A}from"./checkbox-8MlXzZCx.js";import{c as ne}from"./index-JDlOzmVl.js";import{D as we}from"./currency-cell-td0Z0cRW.js";import{u as Pe}from"./currencies--m0OMbks.js";import{f as oe}from"./products-_PEbH1CR.js";import{u as _e,P as Ne}from"./schemas-C0ogkflX.js";import{i as De}from"./utils-UWq8IC3A.js";import{u as Ie,a as ke,b as ze}from"./use-product-table-columns-k99B-kCF.js";import{z as j}from"./index-JzuMwgWW.js";import{P as D}from"./progress-tabs-S8wsVeqQ.js";import"./react-dom-Og6--24v.js";import"./react-router-dom-aSYyayiN.js";import"./drawer-H3TI1lDZ.js";import"./index-sF0hA49A.js";import"./prompt-LzbVPZYR.js";import"./information-circle-solid-rXH6vJ5W.js";import"./label-HFq5fzpT.js";import"./tooltip-Ixyw9oT8.js";import"./currencies-bd3ADI6s.js";import"./empty-table-content-i72rBIA2.js";import"./plus-mini-IRJECoWI.js";import"./index-1Zwdg31z.js";import"./use-date-Putn0_Ur.js";import"./format-vrL-wy9v.js";import"./index-7dV3TD85.js";import"./index-Hm2Uj9Gg.js";import"./lodash-5s15_I2H.js";import"./command-bar-wUgfUfvQ.js";import"./customers--tqEK1Bz.js";import"./text-cell-OtkuJsO8.js";import"./placeholder-cell-O6UVTGmQ.js";import"./minus-E5-czcFC.js";import"./thumbnail-gerN888-.js";import"./readonly-cell-mOmG3VSA.js";import"./constants-oWLT51HC.js";import"./product-types-gZDu6wo-.js";import"./sales-channels--fho5-f4.js";import"./product-cell-gRltbXZC.js";import"./status-cell-9XExsAIG.js";import"./check-circle-solid-7j4QonPK.js";const Ee=({form:t})=>{var g;const[r,n]=C.useState(!1),[x,v]=C.useState(!!((g=t.getValues("customer_group_ids"))!=null&&g.length)),{t:d}=W(),{fields:m,remove:w,append:b}=me({control:t.control,name:"customer_group_ids",keyName:"cg_id"}),S=o=>{const s=o.map(i=>i.id),l=o.filter(i=>!m.some(c=>c.id===i.id));for(const i of m)s.includes(i.id)||w(m.indexOf(i));b(l),n(!1)},y=()=>{n(!0)},h=o=>{o||t.setValue("customer_group_ids",[]),v(o)};return e.jsxs(L,{open:r,onOpenChange:n,children:[e.jsx(L.Content,{children:e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-2 py-16",children:[e.jsxs("div",{children:[e.jsx(ve,{children:d("pricing.create.header")}),e.jsx(N,{size:"small",className:"text-ui-fg-subtle",children:d("pricing.create.hint")})]}),e.jsx(a.Field,{control:t.control,name:"type",render:({field:{onChange:o,...s}})=>e.jsxs(a.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{children:[e.jsx(a.Label,{children:d("fields.type")}),e.jsx(a.Hint,{children:d("pricing.fields.typeHint")})]}),e.jsx(a.Control,{children:e.jsxs(B,{onValueChange:o,...s,className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(B.ChoiceBox,{value:"sale",label:"Sale",description:"Choose this if you are creating a sale"}),e.jsx(B.ChoiceBox,{value:"override",label:"Override",description:"Choose this if you are creating an override"})]})})]}),e.jsx(a.ErrorMessage,{})]})}),e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-4",children:e.jsx(a.Field,{control:t.control,name:"title",render:({field:o})=>e.jsxs(a.Item,{children:[e.jsx(a.Label,{children:d("fields.title")}),e.jsx(a.Control,{children:e.jsx(Se,{...o})}),e.jsx(a.ErrorMessage,{})]})})}),e.jsx(a.Field,{control:t.control,name:"description",render:({field:o})=>e.jsxs(a.Item,{children:[e.jsx(a.Label,{children:d("fields.description")}),e.jsx(a.Control,{children:e.jsx(Ce,{...o})}),e.jsx(a.ErrorMessage,{})]})})]}),e.jsx(V,{}),e.jsx(a.Field,{control:t.control,name:"starts_at",render:({field:{value:o,onChange:s,...l}})=>{const i=c=>{if(!c){s(null);return}s(new Date)};return e.jsx(a.Item,{children:e.jsxs(G,{open:!!o,onOpenChange:i,children:[e.jsxs("div",{className:"grid grid-cols-[1fr_32px] gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-x-1",children:[e.jsx(N,{size:"small",leading:"compact",weight:"plus",children:d("pricing.fields.startDateLabel")}),e.jsxs(N,{size:"small",leading:"compact",className:"text-ui-fg-muted",children:["(",d("fields.optional"),")"]})]}),e.jsx(N,{size:"small",className:"text-ui-fg-subtle",children:d("pricing.fields.startDateHint")})]}),e.jsx(H,{asChild:!0,children:e.jsx(X,{name:l.name,checked:!!o})})]}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col gap-y-2 pt-4",children:[e.jsx(a.Label,{className:"!txt-small text-ui-fg-subtle",children:d("fields.startDate")}),e.jsx(a.Control,{children:e.jsx(J,{value:o||void 0,onChange:s,...l})})]})}),e.jsx(a.ErrorMessage,{})]})})}}),e.jsx(V,{}),e.jsx(a.Field,{control:t.control,name:"ends_at",render:({field:{value:o,onChange:s,...l}})=>{const i=c=>{if(!c){s(null);return}const p=new Date(new Date().setDate(new Date().getDate()+7));s(p)};return e.jsx(a.Item,{children:e.jsxs(G,{open:!!o,onOpenChange:i,children:[e.jsxs("div",{className:"grid grid-cols-[1fr_32px] gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-x-1",children:[e.jsx(N,{size:"small",leading:"compact",weight:"plus",children:d("pricing.fields.endDateLabel")}),e.jsxs(N,{size:"small",leading:"compact",className:"text-ui-fg-muted",children:["(",d("fields.optional"),")"]})]}),e.jsx(N,{size:"small",className:"text-ui-fg-subtle",children:d("pricing.fields.endDateHint")})]}),e.jsx(H,{asChild:!0,children:e.jsx(X,{name:l.name,checked:!!o})})]}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col gap-y-2 pt-4",children:[e.jsx(a.Label,{className:"!txt-small text-ui-fg-subtle",children:d("fields.endDate")}),e.jsx(a.Control,{children:e.jsx(J,{value:o||void 0,onChange:s,...l})})]})}),e.jsx(a.ErrorMessage,{})]})})}}),e.jsx(V,{}),e.jsx("div",{children:e.jsxs(G,{open:x,onOpenChange:h,children:[e.jsx(a.Field,{control:t.control,name:"customer_group_ids",render:({field:o})=>e.jsxs(a.Item,{children:[e.jsxs("div",{className:"grid grid-cols-[1fr_32px] items-start gap-4",children:[e.jsxs("div",{children:[e.jsx(a.Label,{optional:!0,children:d("pricing.fields.customerAvailabilityLabel")}),e.jsx(a.Hint,{children:d("pricing.fields.customerAvailabilityHint")})]}),e.jsx(a.Control,{children:e.jsx(H,{asChild:!0,children:e.jsx(X,{name:o.name,checked:x})})})]}),e.jsx(a.ErrorMessage,{})]})}),e.jsx(M,{children:e.jsxs("div",{className:"flex flex-col pt-4",children:[m.length>0?m.map((o,s)=>e.jsxs("div",{className:"bg-ui-bg-field shadow-borders-base transition-fg hover:bg-ui-bg-field-hover flex h-7 w-fit items-center overflow-hidden rounded-md",children:[e.jsx("div",{className:"txt-compact-small-plus flex h-full select-none items-center justify-center px-2 py-0.5",children:o.name}),e.jsx("button",{type:"button",onClick:()=>w(s),className:"focus-visible:bg-ui-bg-field-hover transition-fg hover:bg-ui-bg-field-hover flex h-full w-7 items-center justify-center border-l outline-none",children:e.jsx(ye,{className:"text-ui-fg-muted"})})]},o.cg_id)):e.jsx("div",{className:"flex items-center justify-center px-2 py-3",children:e.jsx(N,{size:"small",leading:"compact",className:"text-ui-fg-muted",children:d("pricing.fields.customerAvailabilityNoSelectionLabel")})}),e.jsx("div",{className:"flex items-center justify-end",children:e.jsx(z,{size:"small",variant:"secondary",type:"button",onClick:y,children:d("pricing.actions.addCustomerGroups")})})]})})]})})]})})}),e.jsx(Oe,{selectedCustomerGroups:m,saveCustomerGroups:S})]})},q=50,K="cg",U=t=>t.reduce((r,n)=>(r[n.id]=!0,r),{}),Oe=({selectedCustomerGroups:t,saveCustomerGroups:r})=>{const[n,x]=C.useState(U(t)),[v,d]=C.useState(t);C.useEffect(()=>{x(U(t)),d(t)},[t]);const{searchParams:m,raw:w}=je({pageSize:q,prefix:K}),{customer_groups:b,count:S,isLoading:y,isError:h,error:g}=ge(m,{placeholderData:te}),o=c=>{const p=typeof c=="function"?c(n):c,u=Object.keys(n),P=Object.keys(p),k=P.filter(f=>!u.includes(f)),E=u.filter(f=>!P.includes(f)),O=(b==null?void 0:b.filter(f=>k.includes(f.id)).map(f=>({id:f.id,name:f.name})))||[],_=v.filter(f=>!E.includes(f.id));d([..._,...O]),x(p)},s=()=>{r(v)},l=Te(),{table:i}=re({data:b||[],columns:l,count:S,enablePagination:!0,enableRowSelection:!0,getRowId:c=>c.id,rowSelection:{state:n,updater:o},pageSize:q,prefix:K});if(h)throw g;return e.jsx(L.Drawer,{children:e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(ie,{table:i,columns:l,pageSize:q,count:S,isLoading:y,layout:"fill",pagination:!0,search:!0,prefix:K,queryObject:w}),e.jsxs("div",{className:"flex items-center justify-end gap-x-2 border-t p-4",children:[e.jsx(L.Close,{type:"button",asChild:!0,children:e.jsx(z,{variant:"secondary",size:"small",children:Z("actions.cancel")})}),e.jsx(z,{type:"button",variant:"primary",size:"small",onClick:s,children:Z("actions.add")})]})]})})},Re=ne(),Te=()=>{const t=be();return C.useMemo(()=>[Re.display({id:"select",header:({table:r})=>e.jsx(A,{checked:r.getIsSomePageRowsSelected()?"indeterminate":r.getIsAllPageRowsSelected(),onCheckedChange:n=>r.toggleAllPageRowsSelected(!!n)}),cell:({row:r})=>e.jsx(A,{checked:r.getIsSelected(),onCheckedChange:n=>r.toggleSelected(!!n),onClick:n=>{n.stopPropagation()}})}),...t],[t])},Fe=({form:t})=>{var p;const{store:r,isLoading:n,isError:x,error:v}=le(),{currencies:d,isLoading:m,isError:w,error:b}=Pe({code:r==null?void 0:r.supported_currency_codes,limit:(p=r==null?void 0:r.supported_currency_codes)==null?void 0:p.length},{enabled:!!r}),S=F({control:t.control,name:"product_ids"}),y=F({control:t.control,name:"products"}),{products:h,isLoading:g,isError:o,error:s}=oe({id:S.map(u=>u.id),limit:S.length,fields:"title,thumbnail,*variants"}),{setValue:l}=t;C.useEffect(()=>{!g&&h&&h.forEach(u=>{y[u.id]||!u.variants||l(`products.${u.id}.variants`,{...u.variants.reduce((P,k)=>(P[k.id]={currency_prices:{},region_prices:{}},P),{})})})},[h,y,g,l]);const i=_e({currencies:d}),c=g||n||m||!h||!r||!d;if(o)throw s;if(x)throw v;if(w)throw b;return e.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:e.jsx(we,{columns:i,data:h,getSubRows:u=>{if(De(u))return u.variants},isLoading:c,state:t})})},Q=50,Y="p";function Le(t){return t.reduce((r,n)=>(r[n.id]=!0,r),{})}const Ae=({form:t})=>{const{control:r,setValue:n}=t,x=F({control:r,name:"product_ids"}),v=F({control:r,name:"products"}),[d,m]=C.useState(Le(x)),{searchParams:w,raw:b}=Ie({pageSize:Q,prefix:Y}),{products:S,count:y,isLoading:h,isError:g,error:o}=oe(w,{placeholderData:te}),s=p=>{const u=typeof p=="function"?p(d):p,P=Object.keys(u),E=Object.keys(v).reduce((_,f)=>(P.includes(f)&&(_[f]=v[f]),_),{}),O=P.map(_=>({id:_}));n("product_ids",O,{shouldDirty:!0,shouldTouch:!0}),n("products",E,{shouldDirty:!0,shouldTouch:!0}),m(u)},l=Ge(),i=ke(),{table:c}=re({data:S||[],columns:l,count:y,enablePagination:!0,enableRowSelection:p=>p.original.variants.length>0,getRowId:p=>p.id,rowSelection:{state:d,updater:s},pageSize:Q});if(g)throw o;return e.jsx("div",{className:"flex size-full flex-col",children:e.jsx(ie,{table:c,columns:l,filters:i,pageSize:Q,prefix:Y,count:y,isLoading:h,layout:"fill",orderBy:["title","status","created_at","updated_at"],pagination:!0,search:!0,queryObject:b})})},$e=ne(),Ge=()=>{const t=ze();return C.useMemo(()=>[$e.display({id:"select",header:({table:r})=>e.jsx(A,{checked:r.getIsSomePageRowsSelected()?"indeterminate":r.getIsAllPageRowsSelected(),onCheckedChange:n=>r.toggleAllPageRowsSelected(!!n)}),cell:({row:r})=>e.jsx(A,{checked:r.getIsSelected(),disabled:!r.getCanSelect(),onCheckedChange:n=>r.toggleSelected(!!n),onClick:n=>{n.stopPropagation()}})}),...t],[t])},He=j.array(j.object({id:j.string(),name:j.string()})),$=j.object({type:j.enum(["sale","override"]),title:j.string().min(1),description:j.string().min(1),starts_at:j.date().nullable(),ends_at:j.date().nullable(),customer_group_ids:He.optional(),product_ids:j.array(j.object({id:j.string()})).min(1),products:Ne}),ae=$.pick({type:!0,title:!0,description:!0,starts_at:!0,ends_at:!0}),ee=Object.keys(ae.shape),ce=$.pick({product_ids:!0}),se=Object.keys(ce.shape),Me=$.pick({products:!0}),Ve=Object.keys(Me.shape),I=["detail","product","price"],Be={detail:"in-progress",product:"not-started",price:"not-started"},Xe=()=>{const[t,r]=C.useState("detail"),[n,x]=C.useState(Be),{t:v}=W(),{handleSuccess:d}=de(),m=pe({defaultValues:{type:"sale",title:"",description:"",starts_at:null,ends_at:null,customer_group_ids:[],product_ids:[],products:{}},resolver:ue($)}),{mutateAsync:w,isPending:b}=xe(),S=m.handleSubmit(async s=>{const{customer_group_ids:l,products:i}=s,c=l!=null&&l.length?{customer_group_id:l.map(u=>u.id)}:void 0,p=[];for(const[u,P]of Object.entries(i)){const{variants:k}=P;for(const[E,O]of Object.entries(k)){const{currency_prices:_}=O;for(const[f,T]of Object.entries(_))T!=null&&T.amount&&p.push({amount:he(fe(T.amount),f),currency_code:f,variant_id:E})}}await w({title:s.title,type:s.type,description:s.description,starts_at:s.starts_at?s.starts_at.toISOString():null,ends_at:s.ends_at?s.ends_at.toISOString():null,rules:c,prices:p},{onSuccess:({price_list:u})=>{d(`../${u.id}`)}})},s=>console.error(s)),y=(s,l)=>{m.clearErrors(s);const i=s.reduce((p,u)=>(p[u]=m.getValues(u),p),{}),c=l.safeParse(i);return c.success?!0:(c.error.errors.forEach(({path:p,message:u})=>{m.setError(p.join("."),{type:"manual",message:u})}),!1)},h=s=>{switch(s){case"detail":return ee.some(i=>m.getFieldState(i).isDirty);case"product":return se.some(i=>m.getFieldState(i).isDirty);case"price":return Ve.some(i=>m.getFieldState(i).isDirty)}},g=s=>{if(t===s)return;if(I.indexOf(s)<I.indexOf(t)){const i=h(t);x(c=>({...c,[t]:i?c[t]:"not-started",[s]:"in-progress"})),r(s);return}const l=I.slice(0,I.indexOf(s));for(const i of l)if(i==="detail"){if(!y(ee,ae)){x(c=>({...c,[i]:"in-progress"})),r(i);return}x(c=>({...c,[i]:"completed"}))}else if(i==="product"){if(!y(se,ce)){x(c=>({...c,[i]:"in-progress"})),r(i);return}x(c=>({...c,[i]:"completed"}))}x(i=>({...i,[t]:"completed",[s]:"in-progress"})),r(s)},o=s=>{if(I.indexOf(s)+1>=I.length)return;const l=I[I.indexOf(s)+1];g(l)};return e.jsx(R.Form,{form:m,children:e.jsx(D,{value:t,onValueChange:s=>g(s),className:"flex h-full flex-col overflow-hidden",children:e.jsxs("form",{onSubmit:S,className:"flex h-full flex-col",children:[e.jsx(R.Header,{children:e.jsxs("div",{className:"flex w-full items-center justify-between gap-x-4",children:[e.jsx("div",{className:"-my-2 w-full max-w-[400px] border-l",children:e.jsxs(D.List,{className:"grid w-full grid-cols-3",children:[e.jsx(D.Trigger,{status:n.detail,value:"detail",children:"Details"}),e.jsx(D.Trigger,{status:n.product,value:"product",children:"Products"}),e.jsx(D.Trigger,{status:n.price,value:"price",children:"Prices"})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(R.Close,{asChild:!0,children:e.jsx(z,{variant:"secondary",size:"small",children:v("actions.cancel")})}),e.jsx(qe,{tab:t,next:o,isLoading:b})]})]})}),e.jsxs(R.Body,{className:"size-full overflow-hidden",children:[e.jsx(D.Content,{className:"size-full overflow-y-auto",value:"detail",children:e.jsx(Ee,{form:m})}),e.jsx(D.Content,{className:"size-full overflow-y-auto",value:"product",children:e.jsx(Ae,{form:m})}),e.jsx(D.Content,{className:"size-full overflow-hidden",value:"price",children:e.jsx(Fe,{form:m})})]})]})})})},qe=({tab:t,next:r,isLoading:n})=>{const{t:x}=W();return t==="price"?e.jsx(z,{type:"submit",variant:"primary",size:"small",isLoading:n,children:x("actions.save")},"submit-button"):e.jsx(z,{type:"button",variant:"primary",size:"small",onClick:()=>r(t),children:x("actions.continue")},"next-button")},et=()=>e.jsx(R,{children:e.jsx(Xe,{})});export{et as Component};
