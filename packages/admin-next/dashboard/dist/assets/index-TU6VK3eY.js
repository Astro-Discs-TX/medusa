import{u as U,an as V,j as m}from"./index-S--WvUSo.js";import{c as B,b as M}from"./react-router-dom-aSYyayiN.js";import{u as O,a as P}from"./route-focus-modal-MMx5Xnk0.js";import{u as G,b as $,c as H,a as I}from"./price-lists---tSXD3D.js";import{f as W}from"./products-_PEbH1CR.js";import{u as k,a as q}from"./form-0PHaH8g8.js";import{z as J}from"./index-JzuMwgWW.js";import{t as K}from"./zod-jt04JUtm.js";import{r as S}from"./react-PzSkSLoa.js";import{D as Q}from"./currency-cell-td0Z0cRW.js";import{u as X}from"./currencies--m0OMbks.js";import{c as j}from"./cast-number-oeIUIgsb.js";import{b as Y,a as E}from"./money-amount-helpers--myf8Rla.js";import{P as Z,u as rr}from"./schemas-C0ogkflX.js";import{i as or}from"./utils-UWq8IC3A.js";import{B as _}from"./button-Pc5Xo8ua.js";import"./react-dom-Og6--24v.js";import"./drawer-H3TI1lDZ.js";import"./index-sF0hA49A.js";import"./heading-cSlef4Su.js";import"./prompt-LzbVPZYR.js";import"./information-circle-solid-rXH6vJ5W.js";import"./label-HFq5fzpT.js";import"./tooltip-Ixyw9oT8.js";import"./index-JDlOzmVl.js";import"./minus-E5-czcFC.js";import"./currencies-bd3ADI6s.js";import"./thumbnail-gerN888-.js";import"./readonly-cell-mOmG3VSA.js";import"./constants-oWLT51HC.js";const sr=J.object({products:Z}),er=t=>{const i=t.prices,s={};return i&&i.forEach(c=>{const{variant_id:r,currency_code:e,amount:a,id:n}=c;!e||!a||!r||(s[r]||(s[r]=[]),s[r]=[...s[r],{currency_code:e,amount:a,id:n}])}),s},tr=({priceList:t,products:i})=>{const{t:s}=U(),{handleSuccess:c}=O(),r=S.useMemo(()=>er(t),[t]),{store:e,isLoading:a,isError:n,error:u}=V(),{currencies:l,isLoading:p,isError:d,error:o}=X({code:e==null?void 0:e.supported_currency_codes},{enabled:!!e}),f=k({defaultValues:{products:{}},resolver:K(sr)}),h=q({control:f.control,name:"products"});S.useEffect(()=>{ir(i,h,f,r)},[h,f,i,r]);const{mutateAsync:cr,isPending:A}=G(t.id),{mutateAsync:L,isPending:C}=$(t.id),{mutateAsync:w,isPending:D}=H(t.id),R=A||C||D,T=f.handleSubmit(async g=>{const{products:N}=g,{pricesToDelete:b,pricesToCreate:v,pricesToUpdate:ar}=nr(N,r);let y=!1;b.length&&await L({ids:b},{onError(x){console.error(x),y=!0}}),!y&&(v.length&&await w({prices:v},{onError(x){console.error(x),y=!0}}),!y&&c())}),z=rr({currencies:l}),F=a||p||!i||!e||!l;if(n)throw u;if(d)throw o;return m.jsx(P.Form,{form:f,children:m.jsxs("form",{onSubmit:T,className:"flex size-full flex-col",children:[m.jsx(P.Header,{children:m.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[m.jsx(P.Close,{asChild:!0,children:m.jsx(_,{size:"small",variant:"secondary",children:s("actions.cancel")})}),m.jsx(_,{size:"small",type:"submit",isLoading:R,children:s("actions.save")})]})}),m.jsx(P.Body,{className:"flex flex-col overflow-hidden",children:m.jsx(Q,{columns:z,data:i,getSubRows:g=>{if(or(g))return g.variants},isLoading:F,state:f})})]})})};function ir(t,i,s,c){t.forEach(r=>{i[r.id]||!r.variants||s.setValue(`products.${r.id}.variants`,{...r.variants.reduce((e,a)=>{const n=c[a.id]||[];return e[a.id]={currency_prices:n.reduce((u,{currency_code:l,amount:p,id:d})=>{const o=Y(p,l).toString();return u[l]={amount:o,id:d},u},{}),region_prices:{}},e},{})},{shouldDirty:!1,shouldTouch:!1,shouldValidate:!1})})}function nr(t,i){const s=[],c=[],r=[];for(const[e,a]of Object.entries(t)){const{variants:n}=a;for(const[u,l]of Object.entries(n)){const{currency_prices:p}=l;for(const[d,o]of Object.entries(p))if(o){if(o.id&&o.amount){const f=i[u].find(h=>h.id===o.id);if(f&&f.amount===E(j(o.amount),d))continue;s.push({id:o.id,amount:E(j(o.amount),d),currency_code:d,variant_id:u});continue}if(o.id&&!o.amount){r.push(o.id);continue}if(!o.id&&o.amount){c.push({amount:E(j(o.amount),d),currency_code:d,variant_id:u});continue}}}}return{pricesToDelete:r,pricesToCreate:c,pricesToUpdate:s}}const Mr=()=>{const{id:t}=B(),[i]=M(),s=i.get("ids[]"),{price_list:c,isLoading:r,isError:e,error:a}=I(t),n=s==null?void 0:s.split(","),{products:u,isLoading:l,isError:p,error:d}=W({id:n,limit:(n==null?void 0:n.length)||9999,fields:"title,thumbnail,*variants"}),o=!r&&!!c&&!l&&!!u;if(e)throw a;if(p)throw d;return m.jsx(P,{children:o&&m.jsx(tr,{priceList:c,products:u})})};export{Mr as Component};
