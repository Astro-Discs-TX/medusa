import{Z as C,az as K,m as b,u as I,j as e,bm as J,T as d,bn as U,bo as W,bp as X,bq as Y,d as E,br as z,bs as ee,l as te,bt as se}from"./index-S--WvUSo.js";import{o as Z}from"./constants-_5zevAUU.js";import{r as u}from"./react-PzSkSLoa.js";import{u as ae,a as N}from"./route-focus-modal-MMx5Xnk0.js";import{F as g,u as ie}from"./form-0PHaH8g8.js";import{u as ne,r as le,s as Q,n as re,o as ce}from"./index-JzuMwgWW.js";import{b as oe,d as de,c as me}from"./react-router-dom-aSYyayiN.js";import{S as q}from"./split-view-l-bJVVse.js";import{u as ue,a as xe,D as fe}from"./use-data-table-TeZp00wg.js";import{P as pe,a as he}from"./product-cell-gRltbXZC.js";import{M as v}from"./money-amount-cell-qk7EOos5.js";import{C as H}from"./checkbox-8MlXzZCx.js";import{c as ye}from"./index-JDlOzmVl.js";import{B as S}from"./button-Pc5Xo8ua.js";import{T as ge}from"./thumbnail-gerN888-.js";import{A as je}from"./action-menu-olZwXQ3q.js";import{T as be}from"./trash-nTjeUaCp.js";import{I as ve}from"./input-A29ux7yj.js";import{T as _e}from"./textarea-D4fuXHvE.js";import{H as we}from"./heading-cSlef4Su.js";import"./react-dom-Og6--24v.js";import"./drawer-H3TI1lDZ.js";import"./index-sF0hA49A.js";import"./prompt-LzbVPZYR.js";import"./information-circle-solid-rXH6vJ5W.js";import"./label-HFq5fzpT.js";import"./tooltip-Ixyw9oT8.js";import"./empty-table-content-i72rBIA2.js";import"./plus-mini-IRJECoWI.js";import"./index-1Zwdg31z.js";import"./use-date-Putn0_Ur.js";import"./format-vrL-wy9v.js";import"./date-picker-s8-9mila.js";import"./minus-E5-czcFC.js";import"./x-mark-mini-aYDSd38M.js";import"./index-7dV3TD85.js";import"./index-Hm2Uj9Gg.js";import"./lodash-5s15_I2H.js";import"./command-bar-wUgfUfvQ.js";import"./money-amount-helpers--myf8Rla.js";import"./currencies-bd3ADI6s.js";import"./placeholder-cell-O6UVTGmQ.js";const Ne=a=>({queryKey:K.detail(a),queryFn:async()=>b.admin.orders.retrieve(a,{expand:Z})}),jt=async({params:a})=>{const t=a.id,s=Ne(t);return C.getQueryData(s.queryKey)??await C.fetchQuery(s)},w=ye(),Ce=a=>{const{t}=I();return u.useMemo(()=>[w.display({id:"select",header:({table:s})=>e.jsx(H,{checked:s.getIsSomePageRowsSelected()?"indeterminate":s.getIsAllPageRowsSelected(),onCheckedChange:n=>s.toggleAllPageRowsSelected(!!n)}),cell:({row:s})=>e.jsx(H,{checked:s.getIsSelected(),onCheckedChange:n=>s.toggleSelected(!!n),onClick:n=>{n.stopPropagation()}})}),w.display({id:"product",header:()=>e.jsx(pe,{}),cell:({row:s})=>e.jsx(he,{product:s.original.product})}),w.accessor("sku",{header:t("fields.sku")}),w.accessor("title",{header:t("fields.variant")}),w.display({id:"amount",header:()=>e.jsx("div",{className:"text-small text-right font-semibold text-gray-500",children:t("fields.price")}),cell:({row:{original:s}})=>{if(!s.original_price_incl_tax)return null;const n=s.calculated_price_type!=="default";return e.jsx("div",{className:"flex items-center justify-end gap-2",children:e.jsxs("div",{className:"flex flex-col items-end",children:[n&&e.jsx("span",{className:"text-gray-400 line-through",children:e.jsx(v,{currencyCode:a,amount:s.original_price_incl_tax})}),e.jsx("span",{children:e.jsx(v,{currencyCode:a,amount:s.calculated_price_incl_tax})})]})})}})],[t])},Se=()=>{const{t:a}=I();return[{label:a("fields.createdAt"),key:"created_at"},{label:a("fields.updatedAt"),key:"updated_at"}].map(s=>({key:s.key,label:s.label,type:"date"}))},Ie=({pageSize:a=50,prefix:t})=>{const s=ue(["offset","q","title","customer_id","inventory_quantity"],t);return{searchParams:{limit:a,offset:s.offset?Number(s.offset):0,q:s.q,title:s.title,customer_id:s.customer_id,inventory_quantity:s.inventory_quantity?Number(s.inventory_quantity):void 0},raw:s}},M=50,Te=({onSave:a,isAddingItems:t})=>{const{t:s}=I();return e.jsxs("div",{className:"flex items-center justify-end gap-x-2 border-t p-4",children:[e.jsx(q.Close,{type:"button",asChild:!0,children:e.jsx(S,{variant:"secondary",size:"small",children:s("general.close")})}),e.jsx(S,{isLoading:t,size:"small",type:"button",onClick:a,children:s("general.add")})]})},Pe=({onSave:a,order:t,isAddingItems:s})=>{const[n,x]=u.useState({}),[h,m]=u.useState([]),{searchParams:r,raw:c}=Ie({pageSize:M}),{variants:o,count:_,isLoading:f,isError:O,error:R}=J({...r,region_id:t.region_id,cart_id:t.cart_id,customer_id:t.customer_id,currency_code:t.currency_code},{keepPreviousData:!0}),D=j=>{const p=typeof j=="function"?j(n):j,A=Object.keys(p).filter(l=>p[l]!==n[l]);if(A.length){const l=(o==null?void 0:o.filter(y=>A.includes(y.id)))??[];if(l.length>0){const y=l.map(L=>L.id);m(L=>{const $=L.filter(G=>p[G]);return Array.from(new Set([...$,...y]))})}x(p)}const i=Object.keys(n).filter(l=>p[l]!==n[l]);i.length&&(m(l=>l.filter(y=>!i.includes(y))),x(p))},T=()=>{a(h)},P=Ce(t.currency_code),k=Se(),{table:F}=xe({data:o??[],columns:P,count:_,enablePagination:!0,getRowId:j=>j.id,pageSize:M,enableRowSelection:!0,rowSelection:{state:n,updater:D}});if(O)throw R;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(fe,{table:F,columns:P,pageSize:M,count:_,queryObject:c,pagination:!0,search:!0,filters:k,isLoading:f,layout:"fill",orderBy:["title","created_at","updated_at"]}),e.jsx(Te,{isAddingItems:s,onSave:T})]})};function B({item:a,currencyCode:t,form:s,onQuantityChangeComplete:n,onRemove:x}){const{t:h}=I(),m=a.thumbnail;return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl",children:[e.jsxs("div",{className:"flex gap-x-2 border-b p-3 text-sm",children:[e.jsxs("div",{className:"flex flex-grow items-center gap-x-3",children:[e.jsx(ge,{src:m}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(d,{as:"span",weight:"plus",children:a.title}),a.variant.sku&&e.jsxs("span",{children:["($",a.variant.sku,")"]})]}),e.jsx(d,{as:"div",className:"text-ui-fg-subtle",children:a.variant.title})]})]}),e.jsx("div",{className:"text-ui-fg-subtle flex flex-shrink-0",children:e.jsx(v,{currencyCode:t,amount:a.total})}),e.jsx("div",{className:"flex items-center",children:e.jsx(je,{groups:[{actions:[{label:h("actions.remove"),icon:e.jsx(be,{}),onClick:()=>x(a.id)}]}]})})]}),e.jsxs("div",{className:"block p-3 text-sm",children:[e.jsx(d,{weight:"plus",className:"mb-2",children:h("fields.quantity")}),e.jsx(g.Field,{control:s.control,name:a.id,render:({field:r})=>e.jsxs(g.Item,{children:[e.jsx(g.Control,{children:e.jsx(ve,{className:"bg-ui-bg-base w-full rounded-lg",min:1,type:"number",...r,onChange:c=>{const o=c.target.value;r.onChange(o===""?null:Number(o))},onBlur:()=>{typeof s.getValues()[a.id]>"u"&&r.onChange(1),n(a.id)}})}),e.jsx(g.ErrorMessage,{})]})})]})]})}ne(le(Q(),re().optional()),ce({note:Q().optional()}));function ke({order:a,orderEdit:t}){const{t:s}=I(),{handleSuccess:n}=ae(),[,x]=oe(),[h,m]=u.useState(!1),[r,c]=u.useState(!1),[o,_]=u.useState(!1),f=ie({defaultValues:a.items.reduce((i,l)=>(i[l.id]=l.quantity,i),{note:t.internal_note||""})}),{mutateAsync:O}=U(t.id);W(t.id);const{mutateAsync:R}=X(t.id),{mutateAsync:D}=Y(t.id),T=async i=>{c(!0);const l=f.getValues()[i];l>0&&await b.admin.orderEdits.updateLineItem(t.id,i,{quantity:l}),await C.invalidateQueries(z.detail(t.id)),c(!1)},P=u.useMemo(()=>(t==null?void 0:t.items.sort((i,l)=>i.id.localeCompare(l.id)).filter(i=>i.original_item_id))||[],[t]),k=u.useMemo(()=>(t==null?void 0:t.items.sort((i,l)=>i.id.localeCompare(l.id)).filter(i=>!i.original_item_id))||[],[t]);u.useEffect(()=>{t&&(t==null||t.items.forEach(i=>{f.setValue(i.id,i.quantity)}))},[t==null?void 0:t.items.length]);const F=i=>{i||x({},{replace:!0}),m(i)},j=async i=>{_(!0);try{await Promise.all(i.map(l=>R({variant_id:l,quantity:1}))),await C.invalidateQueries(K.detail(a.id))}finally{_(!1)}m(!1)},p=async i=>{c(!0);const l=t.changes.find(y=>y.line_item_id===i||y.original_line_item_id===i);try{l?(l.type==="item_add"&&await b.admin.orderEdits.deleteItemChange(t.id,l.id),l.type==="item_update"&&(await b.admin.orderEdits.deleteItemChange(t.id,l.id),await b.admin.orderEdits.removeLineItem(t.id,i))):await b.admin.orderEdits.removeLineItem(t.id,i),await C.invalidateQueries(z.detail(t.id))}finally{c(!1)}},A=f.handleSubmit(async i=>{c(!0);try{i.note!==(t==null?void 0:t.internal_note)&&await D({internal_note:i.note}),await O()}finally{c(!1)}n(`/orders/${a.id}`)});return e.jsx(N.Form,{form:f,children:e.jsxs("form",{className:"flex h-full flex-col",onSubmit:A,children:[e.jsx(N.Header,{children:e.jsxs("div",{className:"flex   h-full items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(S,{variant:"secondary",size:"small",children:s("actions.cancel")})}),e.jsx(S,{type:"submit",size:"small",isLoading:r,children:s("actions.confirm")})]})}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center overflow-hidden",children:e.jsxs(q,{open:h,onOpenChange:F,children:[e.jsx(q.Content,{children:e.jsx("div",{className:"conatiner mx-auto max-w-[720px]",children:e.jsxs("div",{className:E("flex h-full w-full flex-col pt-16"),children:[e.jsx(we,{level:"h1",className:"pb-8 text-left",children:s("orders.edits.title")}),e.jsx(d,{className:"text-ui-fg-base mb-1",weight:"plus",children:s("orders.edits.currentItems")}),e.jsx(d,{className:"text-ui-fg-subtle mb-4",children:s("orders.edits.currentItemsDescription")}),P.map(i=>e.jsx(B,{item:i,form:f,currencyCode:a.currency_code,onRemove:p,onQuantityChangeComplete:T},i.id)),e.jsxs("div",{className:"border-b border-dashed pb-10 ",children:[e.jsx(d,{className:"text-ui-fg-base mb-1 mt-8",weight:"plus",children:s("orders.edits.addItems")}),e.jsx(d,{className:"text-ui-fg-subtle mb-2",children:s("orders.edits.addItemsDescription")}),!!k.length&&k.map(i=>e.jsx("div",{className:"pb-4 pt-2",children:e.jsx(B,{item:i,form:f,currencyCode:a.currency_code,onRemove:p,onQuantityChangeComplete:T})},i.id)),e.jsx("div",{className:"m mt-2 flex justify-end",children:e.jsx(S,{variant:"secondary",type:"button",onClick:()=>m(!0),children:s("orders.edits.addItems")})})]}),e.jsxs("div",{className:"flex flex-col gap-y-2 border-b border-dashed py-10",children:[e.jsxs("div",{className:"text-ui-fg-subtle flex justify-between text-sm",children:[e.jsx(d,{className:"min-w-[50%] ",children:s("orders.edits.amountPaid")}),e.jsx(v,{align:"right",currencyCode:a.currency_code,amount:a.paid_total-a.refunded_total})]}),e.jsxs("div",{className:"text-ui-fg-subtle flex justify-between text-sm ",children:[e.jsx(d,{className:"min-w-[50%] ",children:s("orders.edits.newTotal")}),e.jsx(v,{align:"right",currencyCode:a.currency_code,amount:t.total})]}),e.jsxs("div",{className:"text-ui-fg-base flex justify-between text-sm",children:[e.jsx(d,{className:"min-w-[50%]",weight:"plus",children:s("orders.edits.differenceDue")}),e.jsx(v,{align:"right",currencyCode:a.currency_code,amount:t.total-a.paid_total})]})]}),e.jsx("div",{className:"py-10",children:e.jsx(g.Field,{control:f.control,name:"note",render:({field:i})=>e.jsxs(g.Item,{children:[e.jsx(d,{className:"text-ui-fg-base mb-1",weight:"plus",children:s("fields.note")}),e.jsx(g.Control,{children:e.jsx(_e,{...i})}),e.jsx(g.ErrorMessage,{})]})})})]})})}),e.jsx(q.Drawer,{children:e.jsx(Pe,{isAddingItems:o,onSave:j,order:a})})]})})]})})}let V=!1;const bt=()=>{const{mutateAsync:a}=ee(),t=de(),{id:s}=me(),{order:n,isLoading:x,isError:h,error:m}=te(s,{expand:Z},{initialData:t}),r=n==null?void 0:n.edits.find(o=>o.status==="created"),{order_edit:c}=se(r==null?void 0:r.id,{expand:"changes,items,items.variant"},{enabled:!!(r!=null&&r.id)});if(u.useEffect(()=>{(async()=>!n||r||V||(V=!0,await a({order_id:n.id}),V=!1))()},[n]),x||!n||!c)return null;if(h)throw m;return e.jsx(N,{children:!x&&n&&e.jsx(ke,{order:n,orderEdit:c})})};export{bt as Component,jt as loader};
