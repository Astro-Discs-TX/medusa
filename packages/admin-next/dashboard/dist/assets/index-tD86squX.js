import{j as e,d as P,T as R,u as D,aj as Z,g as $,I as M,E as J}from"./index-S--WvUSo.js";import{u as Q,a as N}from"./route-focus-modal-MMx5Xnk0.js";import{L as V,u as ee,b as te,c as se}from"./react-router-dom-aSYyayiN.js";import{t as re}from"./zod-jt04JUtm.js";import{r as m}from"./react-PzSkSLoa.js";import{u as ie,c as ne,F as L}from"./form-0PHaH8g8.js";import{z as T}from"./index-JzuMwgWW.js";import{u as B,a as ae}from"./products-_PEbH1CR.js";import{T as H}from"./thumbnail-badge-s2hOPhlu.js";import{A as oe}from"./index-99zzh8bn.js";import{m as le}from"./motion-jlFaYIfJ.js";import{B as k}from"./button-Pc5Xo8ua.js";import{C as w}from"./command-bar-wUgfUfvQ.js";import{T as G}from"./tooltip-Ixyw9oT8.js";import{T as ce}from"./trash-nTjeUaCp.js";import{d as de,T as ue}from"./index-1Zwdg31z.js";import{u as me}from"./use-prompt-wB0F2CxI.js";import"./react-dom-Og6--24v.js";import"./drawer-H3TI1lDZ.js";import"./index-sF0hA49A.js";import"./heading-cSlef4Su.js";import"./prompt-LzbVPZYR.js";import"./information-circle-solid-rXH6vJ5W.js";import"./label-HFq5fzpT.js";import"./input-A29ux7yj.js";var fe=Object.defineProperty,O=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,U=(s,t,r)=>t in s?fe(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,he=(s,t)=>{for(var r in t||(t={}))W.call(t,r)&&U(s,r,t[r]);if(O)for(var r of O(t))K.call(t,r)&&U(s,r,t[r]);return s},pe=(s,t)=>{var r={};for(var i in s)W.call(s,i)&&t.indexOf(i)<0&&(r[i]=s[i]);if(s!=null&&O)for(var i of O(s))t.indexOf(i)<0&&K.call(s,i)&&(r[i]=s[i]);return r};const F=m.forwardRef((s,t)=>{var r=s,{color:i="currentColor"}=r,l=pe(r,["color"]);return m.createElement("svg",he({xmlns:"http://www.w3.org/2000/svg",width:20,height:20,fill:"none",ref:t},l),m.createElement("path",{stroke:i,strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M2.5 13.75v1.875A1.875 1.875 0 0 0 4.375 17.5h11.25a1.875 1.875 0 0 0 1.875-1.875V13.75M13.75 10 10 13.75m0 0L6.25 10M10 13.75V2.5"}))});F.displayName="ArrowDownTray";const xe=({label:s,hint:t,hasError:r,formats:i,onUploaded:l})=>{const[d,f]=m.useState(!1),o=m.useRef(null),c=m.useRef(null),x=()=>{var n;(n=o.current)==null||n.click()},h=n=>{var b;n.preventDefault(),n.stopPropagation(),(b=n.dataTransfer)!=null&&b.files&&f(!0)},v=n=>{n.preventDefault(),n.stopPropagation(),!(!c.current||c.current.contains(n.relatedTarget))&&f(!1)},C=n=>{if(!n)return;const b=Array.from(n).map(a=>{const u=URL.createObjectURL(a);return{id:crypto.randomUUID(),url:u,file:a}});l(b)},S=n=>{var g;n.preventDefault(),n.stopPropagation(),f(!1),C((g=n.dataTransfer)==null?void 0:g.files)},I=async n=>{C(n.target.files)};return e.jsxs("div",{children:[e.jsxs("button",{ref:c,type:"button",onClick:x,onDrop:S,onDragOver:n=>n.preventDefault(),onDragEnter:h,onDragLeave:v,className:P("bg-ui-bg-component border-ui-border-strong transition-fg group flex w-full flex-col items-center gap-y-2 rounded-lg border border-dashed p-8","hover:border-ui-border-interactive focus:border-ui-border-interactive","focus:shadow-borders-focus outline-none focus:border-solid",{"!border-ui-border-error":r,"!border-ui-border-interactive":d}),children:[e.jsxs("div",{className:"text-ui-fg-subtle group-disabled:text-ui-fg-disabled flex items-center gap-x-2",children:[e.jsx(F,{}),e.jsx(R,{children:s})]}),!!t&&e.jsx(R,{size:"small",leading:"compact",className:"text-ui-fg-muted group-disabled:text-ui-fg-disabled",children:t})]}),e.jsx("input",{hidden:!0,ref:o,onChange:I,type:"file",accept:i.join(","),multiple:!0})]})},ge=T.object({id:T.string(),url:T.string(),isThumbnail:T.boolean(),file:T.any().nullable()}),A=["image/jpeg","image/png","image/gif","image/webp","image/heic","image/svg+xml"],be=[".jpeg",".png",".gif",".webp",".heic",".svg"],je=T.object({media:T.array(ge)}),ve=({product:s})=>{const[t,r]=m.useState({}),{t:i}=D(),{handleSuccess:l}=Q(),d=ie({defaultValues:{media:we(s.images,s.thumbnail)},resolver:re(je)}),{fields:f,append:o,remove:c,update:x}=ne({name:"media",control:d.control,keyName:"field_id"}),{mutateAsync:h,isLoading:v}=B(s.id),C=d.handleSubmit(async({media:a})=>{const u=a.map(y=>y.url),p=a.map((y,_)=>({file:y.file,index:_})).filter(y=>y.file);if(p.length){const _=p.map(E=>E.file).map(E=>({url:URL.createObjectURL(E)}));if(!_)return;_.forEach((E,q)=>{const Y=p[q].index;u[Y]=E.url})}const j=a.findIndex(y=>y.isThumbnail),X=j>-1?u[j]:null;await h({images:u,thumbnail:X||""},{onSuccess:()=>{l()}})}),S=a=>{const u=a.find(p=>!A.includes(p.file.type));return u?(d.setError("media",{type:"invalid_file",message:i("products.media.invalidFileType",{name:u.file.name,types:be.join(", ")})}),!0):!1},I=m.useCallback(a=>u=>{if(u)r(p=>({...p,[a]:!0}));else{const{[a]:p,...j}=t;r(j)}},[t]),n=()=>{const u=Object.keys(t).map(p=>f.findIndex(j=>j.id===p));c(u),r({})},g=()=>{const a=Object.keys(t);if(!a.length)return;const u=f.findIndex(j=>j.isThumbnail);u>-1&&x(u,{...f[u],isThumbnail:!1});const p=f.findIndex(j=>j.id===a[0]);x(p,{...f[p],isThumbnail:!0}),r({})},b=Object.keys(t).length;return e.jsx(N.Form,{blockSearch:!0,form:d,children:e.jsxs("form",{className:"flex size-full flex-col overflow-hidden",onSubmit:C,children:[e.jsx(N.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(k,{variant:"secondary",size:"small",children:i("actions.cancel")})}),e.jsx(k,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(V,{to:{pathname:".",search:void 0},children:i("products.media.galleryLabel")})}),e.jsx(k,{size:"small",type:"submit",isLoading:v,children:i("actions.save")})]})}),e.jsx(N.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx("div",{className:"bg-ui-bg-subtle size-full overflow-auto",children:e.jsx("div",{className:"grid h-fit auto-rows-auto grid-cols-4 gap-6 p-6",children:f.map(a=>e.jsx(ye,{onCheckedChange:I(a.id),checked:!!t[a.id],media:a},a.field_id))})}),e.jsx("div",{className:"bg-ui-bg-base border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx(L.Field,{control:d.control,name:"media",render:()=>e.jsx(L.Item,{children:e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-y-1",children:[e.jsx(L.Label,{optional:!0,children:i("products.media.label")}),e.jsx(L.Hint,{children:i("products.media.editHint")})]}),e.jsx(L.Control,{children:e.jsx(xe,{label:i("products.media.uploadImagesLabel"),hint:i("products.media.uploadImagesHint"),hasError:!!d.formState.errors.media,formats:A,onUploaded:a=>{d.clearErrors("media"),!S(a)&&a.forEach(u=>o({...u,isThumbnail:!1}))}})}),e.jsx(L.ErrorMessage,{})]})})})})]})}),e.jsx(w,{open:!!b,children:e.jsxs(w.Bar,{children:[e.jsx(w.Value,{children:i("general.countSelected",{count:b})}),e.jsx(w.Seperator,{}),b===1&&e.jsxs(m.Fragment,{children:[e.jsx(w.Command,{action:g,label:"Make thumbnail",shortcut:"t"}),e.jsx(w.Seperator,{})]}),e.jsx(w.Command,{action:n,label:i("actions.delete"),shortcut:"d"})]})})]})})},ye=({media:s,checked:t,onCheckedChange:r})=>{const[i,l]=m.useState(!0),{t:d}=D(),f=m.useCallback(()=>{r(!t)},[t,r]);return e.jsxs("button",{type:"button",onClick:f,className:"shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full overflow-hidden rounded-lg outline-none",children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(G,{content:d("products.media.thumbnailTooltip"),children:e.jsx(H,{})})}),e.jsx("div",{className:P("transition-fg absolute right-2 top-2 opacity-0 group-focus-within:opacity-100 group-hover:opacity-100 group-focus:opacity-100",{"opacity-100":t}),children:e.jsx("div",{className:P("group relative inline-flex h-5 w-5 items-center justify-center outline-none "),children:e.jsx("div",{className:P("text-ui-fg-on-inverted bg-ui-bg-component shadow-borders-base [&_path]:shadow-details-contrast-on-bg-interactive group-disabled:text-ui-fg-disabled group-disabled:!bg-ui-bg-disabled group-disabled:!shadow-borders-base transition-fg h-[14px] w-[14px] rounded-[3px]",{"bg-ui-bg-interactive group-hover:bg-ui-bg-interactive shadow-borders-interactive-with-shadow":t}),children:t&&e.jsx("div",{className:"absolute inset-0",children:e.jsx(Z,{})})})})}),e.jsx(oe,{children:i&&e.jsx(le.div,{initial:{opacity:1},animate:{opacity:1},exit:{opacity:0,transition:{duration:.5}},className:"bg-ui-bg-subtle-hover absolute inset-0 flex items-center justify-center",children:e.jsx($,{className:"text-ui-fg-subtle animate-spin"})})}),e.jsx("img",{src:s.url,onLoad:()=>l(!1),alt:"",className:"size-full object-cover object-center"})]})},we=(s,t)=>{const r=(s==null?void 0:s.map(i=>({id:i.id,url:i.url,isThumbnail:i.url===t,file:null})))||[];return t&&!r.some(i=>i.url===t)&&r.unshift({id:crypto.randomUUID(),url:t,isThumbnail:!0,file:null}),r},Te=({product:s})=>{const{state:t}=ee(),[r,i]=m.useState((t==null?void 0:t.curr)||0),{t:l}=D(),d=me(),{mutateAsync:f,isLoading:o}=B(s.id),c=Ie(s.images,s.thumbnail),x=m.useCallback(()=>{o||i(n=>(n+1)%c.length)},[c,o]),h=m.useCallback(()=>{o||i(n=>(n-1+c.length)%c.length)},[c,o]),v=m.useCallback(n=>{o||i(n)},[o]),C=()=>{if(o)return;const n=document.createElement("a");n.href=c[r].url,n.download="image",n.target="_blank",n.click()},S=async()=>{const n=c[r];if(!await d({title:l("general.areYouSure"),description:n.isThumbnail?l("products.media.deleteWarningWithThumbnail",{count:1}):l("products.media.deleteWarning",{count:1}),confirmText:l("actions.delete"),cancelText:l("actions.cancel")}))return;const b=s.images.filter(a=>a.id!==n.id).map(a=>a.url);r===c.length-1&&i(a=>a-1),await f({images:b,thumbnail:n.isThumbnail?"":void 0})};m.useEffect(()=>{const n=g=>{g.key==="ArrowRight"?x():g.key==="ArrowLeft"&&h()};return document.addEventListener("keydown",n),()=>{document.removeEventListener("keydown",n)}},[x,h]);const I=!c.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(N.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(M,{size:"small",type:"button",onClick:S,disabled:I,children:[e.jsx(ce,{}),e.jsx("span",{className:"sr-only",children:l("products.media.deleteImageLabel")})]}),e.jsxs(M,{size:"small",type:"button",onClick:C,disabled:I,children:[e.jsx(F,{}),e.jsx("span",{className:"sr-only",children:l("products.media.downloadImageLabel")})]}),e.jsx(k,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(V,{to:{pathname:".",search:"view=edit"},children:l("actions.edit")})})]})}),e.jsxs(N.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(Ne,{curr:r,media:c}),e.jsx(Ce,{curr:r,media:c,prev:h,next:x,goTo:v})]})]})},Ne=({media:s,curr:t})=>{const{t:r}=D();return s.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle text-ui-fg-subtle flex size-full flex-col items-center justify-center gap-y-2",children:[e.jsx(J,{}),e.jsx(R,{size:"small",children:r("products.media.noMediaLabel")})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative h-full w-fit",children:[s[t].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(G,{content:r("products.media.thumbnailTooltip"),children:e.jsx(H,{})})}),e.jsx("img",{src:s[t].url,alt:"",className:"object-fit shadow-elevation-card-rest size-full rounded-xl object-contain"})]})})})},z=8,Ce=({media:s,curr:t,prev:r,next:i,goTo:l})=>{if(!s.length)return null;const f=((o,c)=>{if(o.length<=z)return o;const x=Math.floor(z/2),h=(c-x+o.length)%o.length,v=(h+z)%o.length;return v<h?[...o.slice(h),...o.slice(0,v)]:o.slice(h,v)})(s,t);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(M,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:r,children:e.jsx(de,{})}),e.jsx("div",{className:"flex items-center gap-x-2",children:f.map(o=>{const c=o.id===s[t].id,x=s.findIndex(h=>h.id===o.id);return e.jsx("button",{type:"button",onClick:()=>l(x),className:P("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":c}),children:e.jsx("img",{src:o.url,alt:"",className:"size-full object-cover"})},o.id)})}),e.jsx(M,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:i,children:e.jsx(ue,{})})]})},Ie=(s,t)=>{const r=(s==null?void 0:s.map(i=>({id:i.id,url:i.url,isThumbnail:i.url===t})))||[];return t&&!r.some(i=>i.isThumbnail)&&r.unshift({id:"thumbnail_only",url:t,isThumbnail:!0}),r},Le=m.createContext(null),Se=s=>s.get("view")==="edit"?"edit":"gallery",Ee=({product:s})=>{const[t,r]=te(),i=Se(t),l=d=>()=>{r({view:d})};return e.jsx(Le.Provider,{value:{goToGallery:l("gallery"),goToEdit:l("edit")},children:Pe(i,s)})},Pe=(s,t)=>{switch(s){case"gallery":return e.jsx(Te,{product:t});case"edit":return e.jsx(ve,{product:t})}},st=()=>{const{id:s}=se(),{product:t,isLoading:r,isError:i,error:l}=ae(s),d=!r&&t;if(i)throw l;return e.jsx(N,{children:d&&e.jsx(Ee,{product:t})})};export{st as Component};
