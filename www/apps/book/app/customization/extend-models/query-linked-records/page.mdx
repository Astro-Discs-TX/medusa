import { CodeTab, CodeTabs, TypeList, Tabs, TabsList, TabsTriggerVertical, TabsContent, TabsContentWrapper } from "docs-ui"

export const metadata = {
  title: `${pageNumber} Retrieve Linked Records using Query`,
}

# {metadata.title}

In this chapter, you'll learn how to retrieve data across linked records using the Query.

## What is the Query?

The Query is a function that retrieves data across modules and their links. It’s registered in the Medusa container under the `query` registration name.

For example, create the API route `src/api/store/query/route.ts` with the following content:

export const exampleHighlights = [
  ["14", "", "Resolve the Query from the Medusa container."],
  ["17", "graph", "Run a query to retrieve the brands."],
  ["18", "entryPoint", "The name of the data model you're querying."],
  ["19", "fields", "An array of the data model’s properties to retrieve in the result."],
]

```ts title="src/api/store/query/route.ts" highlights={exampleHighlights} apiTesting testApiMethod="GET" testApiUrl="http://localhost:9000/store/query" collapsibleLines="1-12" expandButtonLabel="Show Imports"
import { 
  MedusaRequest, 
  MedusaResponse,
} from "@medusajs/medusa"
import { 
  ContainerRegistrationKeys,
} from "@medusajs/utils"

export async function GET(
  req: MedusaRequest,
  res: MedusaResponse
): Promise<void> {
  const query = req.scope.resolve(
    ContainerRegistrationKeys.QUERY
  )

  const { data: brands } = await query.graph({
    entryPoint: "brand",
    fields: ["id", "name"],
  })

  res.json({
    brands
  })
}
```

In the above example, you resolve the Query from the Medusa container using the `ContainerRegistrationKeys.QUERY` (`query`) key.

Then, you run a query using its `graph` method. This method accepts as a parameter an object with the following required properties:

- `entryPoint`: The data model's name, as specified in the first parameter of the `model.define` method used for the data model's definition.
- `fields`: An array of the data model’s properties to retrieve in the result.

The method returns an object that has a `data` property, which holds an array of the retrieved brands. For example:

```json title="Returned Data"
{
  "data": [
    {
      "id": "123",
      "name": "Acme",
      "created_at": "...",
      "updated_at": "..."
    }
  ]
}
```

---

## Retrieve Linked Records

Retrieve the records of a linked data model by passing in `fields` the data model's name suffixed with `.*`.

For example, to retrieve the products of a brand:

<CodeTabs group="query-link-type">
  <CodeTab value="list" label="List Links">

```ts highlights={[["6"]]}
const { data: brands } = await query.graph({
  entryPoint: "brand",
  fields: [
    "id", 
    "name",
    "products.*",
  ],
})
```

  </CodeTab>
  <CodeTab value="default" label="Default Links">

```ts highlights={[["6"]]}
const { data: brands } = await query.graph({
  entryPoint: "brand",
  fields: [
    "id", 
    "name",
    "product.*",
  ],
})
```

  </CodeTab>
</CodeTabs>

For list links, pass the plural name of the linked data model suffixed with `.*`.

Otherwise, for default links, pass the data model's name suffixed with `.*`.

<Note title="Tip">

`.*` means that all of data model's properties should be retrieved. To retrieve a specific property, replace the `*` with the property's name. For example, `product.title`.

</Note>

---

## Apply Filters

```ts highlights={[["6"], ["7"], ["8"], ["9"]]}
const { data: brands } = await query.graph({
  entryPoint: "brand",
  fields: ["id", "name"],
  variables: {
    filters: {
      id: [
        "01HWSVWR4D2XVPQ06DQ8X9K7AX",
        "01HWSVWK3KYHKQEE6QGS2JC3FX",
      ],
    },
  },
})
```

The `query.graph` method accepts a `variables` property. You can use this property to filter retrieved records.

<TypeList
  types={[
    {
      name: "variables",
      type: "`object`",
      description: "Variables to pass to the query.",
      children: [
        {
          name: "filters",
          type: "`object`",
          description: "The filters to apply on any of the data model's properties."
        }
      ]
    },
  ]}
  sectionTitle="Apply Filters"
/>

---

## Sort Records

```ts highlights={[["5"], ["6"], ["7"]]}
const { data: brands } = await query.graph({
  entryPoint: "brand",
  fields: ["id", "name"],
  variables: {
    order: {
      name: "DESC",
    },
  },
})
```

To sort returned records, pass an `order` property to `variables`.

The `order` property is an object whose keys are property names, and values are either:

- `ASC` to sort records by that property in ascending order.
- `DESC` to sort records by that property in descending order.

---

## Apply Pagination

```ts highlights={[["8", "skip", "The number of records to skip before fetching the results."], ["10", "take", "The number of records to fetch."]]}
const { 
  data: brands,
  metadata: { count, take, skip },
} = await query.graph({
  entryPoint: "brand",
  fields: ["id", "name"],
  variables: {
    skip: 0,
    take: 10,
  },
})
```

To paginate the returned records, pass the following properties to `variables`:

- `skip`: (required to apply pagination) The number of records to skip before fetching the results.
- `take`: The number of records to fetch.

When you provide the pagination fields, the `query.graph` method's returned object has a `metadata` property. Its value is an object having the following properties:

<TypeList types={[
  {
    name: "skip",
    type: "`number`",
    description: "The number of records skipped."
  },
  {
    name: "take",
    type: "`number`",
    description: "The number of records requested to fetch."
  },
  {
    name: "count",
    type: "`number`",
    description: "The total number of records."
  }
]} sectionTitle="Apply Pagination" />

---

## Next: Pass Data For Linked Models in Routes

After linking the `brand` and `product` data models, you want to utilize the Create Product API route so that, when a brand is supplied in the request body, it links the brand to the product.

The next chapter explains how to extend existing API routes with additional data and functionalities.
